<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>å¹¸è¿æŠ½å¥–</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#ffe7d6,#ff9a8b);
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial;
  display:flex;
  justify-content:center;
  align-items:center;
}
.container{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:22px;
  padding:20px 16px 28px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
  text-align:center;
}
h2{
  margin:4px 0 8px;
  font-size:24px;
}
.status{
  font-size:15px;
  color:#666;
}
#wheelBox{
  position:relative;
  width:100%;
  margin:18px auto 10px;
}
canvas{
  width:100%;
  height:auto;
}
.pointer{
  position:absolute;
  top:-6px;
  left:50%;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:16px solid transparent;
  border-right:16px solid transparent;
  border-bottom:28px solid #ff3b3b;
  filter:drop-shadow(0 4px 4px rgba(0,0,0,.3));
}
.spin-btn{
  margin-top:14px;
  width:80%;
  height:52px;
  border:none;
  border-radius:26px;
  font-size:20px;
  font-weight:bold;
  color:#fff;
  background:linear-gradient(135deg,#ff512f,#dd2476);
  box-shadow:0 8px 18px rgba(0,0,0,.25);
}
.spin-btn:active{transform:scale(.96)}
ul{
  margin-top:12px;
  padding:0;
  list-style:none;
  font-size:14px;
  color:#444;
}
li{padding:3px 0}
</style>
</head>

<body>

<div class="container">
  <h2>ğŸ å¹¸è¿æŠ½å¥–</h2>
  <div class="status">ğŸ« å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š<b id="chance">0</b></div>

  <div id="wheelBox">
    <div class="pointer"></div>
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>

  <button class="spin-btn" onclick="spin()">ğŸ¯ å¼€å§‹æŠ½å¥–</button>

  <ul id="history"></ul>
</div>

<script>
/* ===== å¥–é¡¹é…ç½® ===== */
const prizes = [
  { name:"æŠ–éŸ³1å·ä¸€ä¸ª", img:"images/prize1.png" },
  { name:"å¤§åŒ…é›¶é£Ÿç¢ç‰‡", img:"images/prize2.png" },
  { name:"å¢¨é•œç¢ç‰‡", img:"images/prize3.png" },
  { name:"å†æ¥ä¸€æ¬¡", img:"images/prize4.png" }
];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const size = canvas.width;
const center = size/2;
const slice = 2*Math.PI/prizes.length;

let currentAngle = 0;
let spinning = false;

/* ===== å›¾ç‰‡é¢„åŠ è½½ ===== */
const images = {};
let loaded = 0;
prizes.forEach(p=>{
  const img = new Image();
  img.src = p.img;
  img.onload = ()=>{ if(++loaded===prizes.length) draw(); }
  images[p.name]=img;
});

/* ===== ç»˜åˆ¶è½¬ç›˜ ===== */
function drawWheel(){
  prizes.forEach((p,i)=>{
    const start = i*slice;
    const end = start+slice;

    ctx.beginPath();
    ctx.moveTo(center,center);
    ctx.arc(center,center,center-6,start,end);
    ctx.fillStyle = i%2 ? "#ffe082" : "#ffab91";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.stroke();

    const angle = start+slice/2;

    // å›¾ç‰‡ï¼ˆé è¿‘åœ†å¿ƒï¼‰
    const rImg = 85;
    const img = images[p.name];
    if(img){
      ctx.drawImage(
        img,
        center + rImg*Math.cos(angle) - 28,
        center + rImg*Math.sin(angle) - 28,
        56,56
      );
    }

    // æ–‡å­—ï¼ˆå¤–åœˆï¼‰
    const rText = 135;
    ctx.fillStyle="#333";
    ctx.font="bold 18px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(
      p.name,
      center + rText*Math.cos(angle),
      center + rText*Math.sin(angle)
    );
  });
}

/* ===== æ¯å¸§ç»˜åˆ¶ ===== */
function draw(){
  ctx.clearRect(0,0,size,size);
  ctx.save();
  ctx.translate(center,center);
  ctx.rotate(currentAngle);
  ctx.translate(-center,-center);
  drawWheel();
  ctx.restore();
}

/* ===== æŠ½å¥– ===== */
async function spin(){
  if(spinning) return;
  spinning = true;

  const res = await fetch("/api/lottery",{method:"POST"});
  const data = await res.json();

  const index = prizes.findIndex(p=>p.name===data.prize.name);
  rotateTo(index);
}

/* ===== ç²¾å‡†å¯¹é½æŒ‡é’ˆ ===== */
function rotateTo(index){
  const targetAngle =
    Math.PI*8 + (Math.PI*1.5) - (index*slice + slice/2);

  const start = currentAngle;
  const duration = 3600;
  let startTime=null;

  function anim(t){
    if(!startTime) startTime=t;
    const p=Math.min((t-startTime)/duration,1);
    const ease=1-Math.pow(1-p,3);
    currentAngle=start+(targetAngle-start)*ease;
    draw();
    if(p<1) requestAnimationFrame(anim);
    else{
      spinning=false;
      loadStatus();
      alert("ğŸ‰ æŠ½ä¸­ï¼š"+prizes[index].name);
    }
  }
  requestAnimationFrame(anim);
}

/* ===== çŠ¶æ€ ===== */
async function loadStatus(){
  const res=await fetch("/api/status");
  const data=await res.json();
  chance.innerText=data.chances;
  history.innerHTML=data.history.map(h=>`<li>${h.time} - ${h.prize}</li>`).join("");
}

draw();
loadStatus();
</script>

</body>
</html>
