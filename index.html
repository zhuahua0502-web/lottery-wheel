<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>å¹¸è¿æŠ½å¥–</title>
<style>
body {
  margin: 0;
  background: linear-gradient(180deg,#ffecd2,#fcb69f);
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", Arial;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
  text-align: center;
}
#wheelBox { width: 100%; max-width: 320px; margin: 16px auto; }
canvas { display: block; width: 100%; height: auto; }
.spin-btn {
  width: 80%; height: 50px; font-size: 20px; font-weight: bold; color: #fff;
  background: linear-gradient(135deg,#ff512f,#dd2476); border: none; border-radius: 25px;
  box-shadow: 0 6px 12px rgba(0,0,0,.25);
}
.spin-btn:active { transform: scale(.96); }
ul { list-style: none; padding: 0; font-size: 14px; }
li { padding: 3px 0; }

#resultPopup {
  position: fixed;
  top: 25%; left: 50%;
  transform: translateX(-50%) scale(0);
  background: rgba(255,255,255,0.95);
  padding: 16px 24px;
  border-radius: 12px;
  font-size: 20px;
  font-weight: bold;
  color: #ff3b3b;
  box-shadow: 0 6px 12px rgba(0,0,0,0.25);
  text-align: center;
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0; z-index: 9999;
}
#resultPopup img { width: 60px; height: 60px; display: block; margin: 0 auto 8px; }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ ä¸¸å®ä¸“å±ç ´è›‹æŠ½å¥–</h2>
  <p>ğŸ« å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š<b id="chance">0</b></p>
  <div id="wheelBox">
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>
  <button class="spin-btn" onclick="spin()">ğŸ¯ å¼€å§‹æŠ½å¥–</button>
  <h3>ğŸ“œ æŠ½å¥–è®°å½•</h3>
  <ul id="history"></ul>
</div>

<div id="resultPopup">
  <img id="resultImg" src="" alt="">
  <div>ğŸ‰ <span id="resultText"></span></div>
</div>

<script>
const prizeNames = ["æŠ–éŸ³1å·ä¸€ä¸ª","å¤§åŒ…é›¶é£Ÿç¢ç‰‡","å¢¨é•œç¢ç‰‡","å†ç ´ä¸€æ¬¡"];
const prizeImages = {
  "æŠ–éŸ³1å·ä¸€ä¸ª":"images/prize1.png",
  "å¤§åŒ…é›¶é£Ÿç¢ç‰‡":"images/prize2.png",
  "å¢¨é•œç¢ç‰‡":"images/prize3.png",
  "å†ç ´ä¸€æ¬¡":"images/prize4.png"
};
const loadedImages = {};
const placeholder = "https://via.placeholder.com/60";

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const center = canvas.width/2;
let currentAngle = 0;
let spinning = false;

// å›¾ç‰‡/æ–‡å­—å‚æ•°
const prizePosition = {
  "æŠ–éŸ³1å·ä¸€ä¸ª":    { imgRadius: 60, textRadius: 120 },
  "å¤§åŒ…é›¶é£Ÿç¢ç‰‡":  { imgRadius: 60, textRadius: 120 },
  "å¢¨é•œç¢ç‰‡":      { imgRadius: 60, textRadius: 120 },
  "å†ç ´ä¸€æ¬¡":      { imgRadius: 60, textRadius: 120 }
};

// ç»˜åˆ¶è½¬ç›˜
function drawWheel(){
  const slice = 2*Math.PI/prizeNames.length;
  for(let i=0;i<prizeNames.length;i++){
    const start = i*slice;
    const name = prizeNames[i];
    const pos = prizePosition[name] || { imgRadius:60, textRadius:120 };

    // æ‰‡åŒº
    ctx.beginPath();
    ctx.moveTo(center,center);
    ctx.arc(center,center,center-4,start,start+slice);
    ctx.fillStyle = i%2 ? "#ffe082" : "#ffab91";
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.stroke();

    // å›¾ç‰‡åæ ‡
    const imgAngle = start + slice/2;
    const imgX = center + pos.imgRadius * Math.cos(imgAngle) - 30;
    const imgY = center + pos.imgRadius * Math.sin(imgAngle) - 30;

    // æ–‡å­—åæ ‡
    const textX = center + pos.textRadius * Math.cos(imgAngle);
    const textY = center + pos.textRadius * Math.sin(imgAngle);

    const imgSrc = loadedImages[name]?.src || placeholder;
    const img = new Image();
    img.src = imgSrc;
    ctx.drawImage(img,imgX,imgY,60,60);

    ctx.fillStyle="#333";
    ctx.font="bold 20px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(name,textX,textY);
  }
}

// ç»˜åˆ¶æŒ‡é’ˆå’Œè½¬ç›˜
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(center,center);
  ctx.rotate(currentAngle);
  ctx.translate(-center,-center);
  drawWheel();
  ctx.restore();

  // æŒ‡é’ˆ
  ctx.fillStyle="#ff3b3b";
  ctx.beginPath();
  ctx.moveTo(center-16,0);
  ctx.lineTo(center+16,0);
  ctx.lineTo(center,40);
  ctx.closePath();
  ctx.fill();
}

// å¼¹çª—æ˜¾ç¤ºä¸­å¥–ç»“æœ
function showResultPopup(prizeName){
  const popup = document.getElementById("resultPopup");
  const resultText = document.getElementById("resultText");
  const resultImg = document.getElementById("resultImg");

  resultText.innerText = prizeName;
  const imgSrc = loadedImages[prizeName]?.src || placeholder;
  resultImg.src = imgSrc;
  resultImg.style.display = "block";

  popup.style.transform = "translateX(-50%) scale(1)";
  popup.style.opacity = "1";

  setTimeout(()=>{
    popup.style.transform = "translateX(-50%) scale(0)";
    popup.style.opacity = "0";
  },2000);
}

// æŠ½å¥–
async function spin(){
  if(spinning) return;
  spinning=true;

  try{
    const res = await fetch("/api/lottery",{method:"POST"});
    const data = await res.json();
    if(data.code!==200){
      alert(data.msg);
      spinning=false;
      return;
    }

    let prizeName = data.prize.name?.trim()||"";
    let index = prizeNames.findIndex(p=>p.replace(/\s/g,"")===prizeName.replace(/\s/g,""));
    if(index===-1) index=0;

    rotateTo(index);

  }catch(e){
    alert("ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    spinning=false;
  }
}

// è½¬ç›˜æ—‹è½¬åŠ¨ç”»ï¼ˆä¿®æ­£æŒ‡é’ˆæ–¹å‘ï¼‰
function rotateTo(index){
  const slice = 2 * Math.PI / prizeNames.length;

  // âœ… æ¯æ¬¡éƒ½é¢å¤–å¤šè½¬çš„åœˆæ•°ï¼ˆå¯è°ƒï¼Œæ¨è 6~10ï¼‰
  const extraSpins = 6 + Math.floor(Math.random() * 3); // 6~8åœˆ

  // æŒ‡é’ˆåœ¨æ­£ä¸Šæ–¹
  const pointerOffset = Math.PI / 2;

  // âœ… å…³é”®ï¼šç›®æ ‡è§’åº¦ = å½“å‰è§’åº¦ + å¤šåœˆ + å¯¹é½ä¿®æ­£
  const targetAngle =
    currentAngle
    + extraSpins * 2 * Math.PI
    + (2 * Math.PI - (index * slice + slice / 2))
    - pointerOffset;

  const startAngle = currentAngle;
  const duration = 4500;
  let startTime = null;

  function anim(t){
    if(!startTime) startTime = t;
    const progress = Math.min((t - startTime) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3);

    currentAngle = startAngle + (targetAngle - startAngle) * ease;
    draw();

    if(progress < 1){
      requestAnimationFrame(anim);
    } else {
      currentAngle = targetAngle; // é˜²æ­¢ç´¯è®¡è¯¯å·®
      spinning = false;
      loadStatus();
      showResultPopup(prizeNames[index]);
    }
  }

  requestAnimationFrame(anim);
}


// åŠ è½½å‰©ä½™æ¬¡æ•°å’ŒæŠ½å¥–å†å²
async function loadStatus(){
  try{
    const res = await fetch("/api/status");
    const data = await res.json();
    document.getElementById("chance").innerText = data.chances;
    document.getElementById("history").innerHTML=
      data.history.map(h=>`<li>${h.time} - ${h.prize}</li>`).join("");
  }catch(e){
    console.warn("çŠ¶æ€åŠ è½½å¤±è´¥");
  }
}

// åˆå§‹åŒ–
function init(){
  draw();
  loadStatus();
}

// å›¾ç‰‡é¢„åŠ è½½
for(let name in prizeImages){
  const img = new Image();
  img.src = prizeImages[name];
  img.onload=()=>{ loadedImages[name]=img; draw(); }
  img.onerror=()=>{ console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${prizeImages[name]}`);}
}

init();
</script>

</body>
</html>
